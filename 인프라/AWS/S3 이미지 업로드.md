## Stream 업로드
![[Pasted image 20240909205851.png]]
- 특징
	- 업로드할 파일의 바이너리 전체를 Spring Boot 애플리케이션을 실행하고 있는 서버의 디스크나 힙 메모리에 저장하지 않는다
	- 모든 바이너리를 메모리에 로드하지 않는 이상 전 전처리(ex. 이미지 리사이징)가 불가능하다.
	- 1회 API 호출에 1개 파일만을 업로드(바이너리에 파일 구분 기준이 없다.)
- 고려사항
	- 클라이언트 네트워크 환경, 클라우드 인스턴스 유형에 따라 업로드 속도 편차가 크기 때문에 운영환경과 동일한 인프라로 충분한 속도 테스트가 필요합니다.
	- Stream 업로드 방식은 구조적으로 클라이언트에게 업로드 현황을 제공할 수 없습니다. 따라서 클라이언트가 기다릴 수 있을만큼 적당한 파일사이즈 제한이 필요합니다.
	- 대용량 파일을 업로드 중 오류가 발생했을 때 전체 파일을 처음부터 다시 업로드해야하기 때문에 시간과 대역폭이 낭비될 수 있습니다.

## MultipartFile 업로드
![[Pasted image 20240909205916.png]]
![[Pasted image 20240909210401.png]]
- 특징
	- Stream 업로드에 비해 더 높은 수준의 추상화와 편의성을 제공
	- 파일을 업로드했을 때 `WAS(Tomcat)`가 해당 파일을 임시 디렉터리(location)에 저장
	- 임시 디렉터리에 저장된 파일은 힙 메모리에 올라가는 것이 아닌 `Servlet Container Disk(컨테이너가 실행되고 있는 서버의 디스크)`에 저장됨
	- 단일 API 호출로 여러 개의 파일을 동시에 업로드할 수 있다.


## AWS Multipart 업로드
![[Pasted image 20240909211039.png]]
- 특징
	- AWS S3에서 제공하는 파일 업로드 방식
	- 업로드할 파일을 작은 part로 나누어 각 부분을 개별적으로 업로드
	- 파일의 바이너리가 Spring Boot를 거치지 않고 AWS S3에 다이렉트로 업로드(서버 부하 X)
- 프로세스
	- Multipart 업로드 시작
		- 멀티파트 업로드에 대한 고유 식별자인 `Upload ID`를 응답
	- PresignedURL 발급
		- 업로드를 위한 AWS의 서명된 URL을 발급받는 요청
	- PresignedURL part 업로드
		- `PresignedURL`에 PUT 메소드로 파트의 바이너리를 실어서 요청
		- 분할된 파트는 5MB~5GB 만 가능하다.
		- 파트를 업로드 후 받는 응답 헤더에 [MD5 Checksum](https://ko.wikipedia.org/wiki/MD5) 값인 `ETag(Entity Tag)`가 포함되어 있다.
	- Multipart 업로드 완료
		- 멀티파트 업로드 완료는 `Upoad ID`, 각 `PartNumber`와 매칭되는 `ETag` 값이 배열로 포함되어야 한다.
		- 업로드 완료를 하지 않을 경우 S3 버킷에 파일이 생성되지 않습니다.
		- 예외 - Multipart 업로드 취소
			- 클라이언트에서 예외 발생 시 멀티파트 업로드를 취소할 것을 권장
		-  AWS S3 bucket에 CORS 설정이 필요

| 특징/방식                | Stream     | MultipartFile             | AWS Multipart    |
| -------------------- | ---------- | ------------------------- | ---------------- |
| **파일 크기 제한**         | 이론상 없음     | 디스크/메모리에 의존(설정에 따라 제한 가능) | 최대 5TB           |
| **파일 바이너리 서버 경유 유무** | △ (Buffer) | ○ (설정에 따라 발생 가능)          | ✕                |
| **구현 복잡성**           | 단순         | 중간                        | 복잡               |
| **업로드 과정의 복잡성**      | 단순         | 중간                        | 복잡               |
| **AWS S3 의존성**       | 일반적        | 일반적                       | 높음               |
| **진행 상태 표시 가능 여부**   | ✕          | ✕                         | ○                |
| **CORS 설정 필요 여부**    | ✕          | ✕                         | ○                |
| **운영 유지보수**          | ✕          | ○ (주기적인 임시파일 삭제)          | ✕ (S3 Lifecycle) |